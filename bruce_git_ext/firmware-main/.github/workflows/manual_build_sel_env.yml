name: Manual Build (Select Environment)
# All credits to Ninja-Jr @ninjajr
on:
  workflow_dispatch:
    inputs:
      target_branch:
        description: 'Branch to build from'
        required: true
        default: 'main'
        type: string
      environment:
        description: 'Select environment to build'
        required: true
        default: 'lilygo-t-embed-cc1101'
        type: choice
        options:
          - "m5stack-cardputer"
          - "m5stack-cplus2"
          - "m5stack-cplus1_1"
          - "LAUNCHER_m5stack-cplus1_1"
          - "m5stack-core2"
          - "m5stack-core16mb"
          - "m5stack-core4mb"
          - "m5stack-cores3"
          - "esp32-s3-devkitc-1"
          - "esp32-c5"
          - "esp32-c5-tft"
          - "CYD-2432S028"
          - "CYD-2USB"
          - "CYD-2432W328C"
          - "CYD-2432W328C_2"
          - "CYD-2432W328R-or-S024R"
          - "CYD-3248S035R"
          - "CYD-3248S035C"
          - "LAUNCHER_CYD-2432W328R-or-S024R"
          - "LAUNCHER_CYD-2432S028"
          - "LAUNCHER_CYD-2USB"
          - "LAUNCHER_CYD-2432W328C"
          - "LAUNCHER_CYD-3248S035R"
          - "LAUNCHER_CYD-3248S035C"
          - "lilygo-t-embed-cc1101"
          - "lilygo-t-embed"
          - "lilygo-t-deck"
          - "lilygo-t-watch-s3"
          - "lilygo-t-deck-pro"
          - "lilygo-t-display-s3"
          - "lilygo-t-display-s3-touch"
          - "lilygo-t-display-s3-mmc"
          - "lilygo-t-display-s3-touch-mmc"
          - "lilygo-t-display-s3-pro"
          - "lilygo-t-display-ttgo"
          - "lilygo-t-hmi"
          - "lilygo-t-lora-pager"
          - "smoochiee-board"
          - "Phantom_S024R"
          - "LAUNCHER_Phantom_S024R"
          - "Marauder-Mini"
          - "LAUNCHER_Marauder-Mini"
          - "Awok-Mini"
          - "Marauder-v7"
          - "LAUNCHER_Marauder-v7"
          - "Marauder-V4-V6"
          - "Marauder-v61"
          - "LAUNCHER_Marauder-V4-V6"
          - "LAUNCHER_Marauder-v61"
          - "Awok-Touch"
          - "WaveSentry-R1"
          - "LAUNCHER_WaveSentry-R1"

jobs:
  compile_selected:
    name: Build ${{ github.event.inputs.environment }}
    runs-on: ubuntu-latest
    env:
      SELECTED_ENV: ${{ github.event.inputs.environment }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.target_branch }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
            ${{ runner.os }}-pip-

      - name: Cache PlatformIO Framework
        uses: actions/cache@v4
        with:
          path: ~/.platformio
          key: ${{ runner.os }}-platformio-${{ hashFiles('platformio.ini') }}
          restore-keys: |
            ${{ runner.os }}-platformio-${{ hashFiles('platformio.ini') }}
            ${{ runner.os }}-platformio-

      - name: PIO libraries cache
        uses: actions/cache@v4
        with:
          path: .pio/libdeps
          key: ${{ runner.os }}-pio-${{ env.SELECTED_ENV }}-${{ hashFiles('platformio.ini') }}
          restore-keys: |
            ${{ runner.os }}-pio-${{ env.SELECTED_ENV }}-${{ hashFiles('platformio.ini') }}
            ${{ runner.os }}-pio-${{ env.SELECTED_ENV }}-

      - name: Install dependencies
        run: |
          pip install requests esptool intelhex
          pip install platformio

      - name: Prepare PlatformIO file (Bruce version logic)
        id: prepare_version
        run: |
          echo "Preparing PlatformIO configuration..."

          # Manual builds always use commit SHA (simple and logical)
          version="${GITHUB_SHA::7}"
          echo "Using commit SHA: $version"

          echo "VERSION=$version" >> $GITHUB_OUTPUT

          # Apply version to platformio.ini (upstream method)
          sed -i "s/-DBRUCE_VERSION=/-DBRUCE_VERSION='\"$version\"' ; /g" ./platformio.ini
          sed -i "s/-DGIT_COMMIT_HASH='\"Homebrew\"'/!echo '-DGIT_COMMIT_HASH=\\\\\"'\$(git describe --always --dirty)'\\\\\"'/g" ./platformio.ini

      - name: Run Compile
        run: |
          set -o pipefail
          echo "Building environment: ${{ env.SELECTED_ENV }}"
          platformio run -e "${{ env.SELECTED_ENV }}" | tee "build-${{ env.SELECTED_ENV }}.log"

      - name: Build summary
        run: |
          if [[ -f "build-${{ env.SELECTED_ENV }}.log" ]]; then
            echo "Last 75 lines of build-${{ env.SELECTED_ENV }}.log:"
            tail -n 75 "build-${{ env.SELECTED_ENV }}.log"
          else
            echo "Build log not found; nothing to show."
          fi

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Bruce-${{ env.SELECTED_ENV }}
          path: Bruce-*.*
          retention-days: 1
          if-no-files-found: error

      - name: Display Build Info
        run: |
          echo "Build completed successfully!"
          echo "Environment: ${{ env.SELECTED_ENV }}"
          echo "Version: ${{ steps.prepare_version.outputs.VERSION }}"
          echo "Git Hash: $(git describe --always --dirty)"
          echo "Built files:"
          ls -la Bruce-*.* 2>/dev/null || echo "No Bruce files found"
